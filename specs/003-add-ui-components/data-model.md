# Data Model: Session Management UI Components

## Core Entities

### MonthSession
Represents a monthly expense processing session with complete lifecycle management.

**Attributes**:
- `id: string` - Unique identifier (UUID v4)
- `name: string` - User-defined name (e.g., "January 2024", "Q1 Processing")
- `createdAt: number` - Unix timestamp of creation
- `expiresAt: number` - Unix timestamp when session expires (createdAt + 1 year)
- `status: SessionStatus` - Current processing state
- `backendSessionId: string` - Associated backend session identifier
- `lastUpdated: number` - Unix timestamp of last modification
- `hasReports: boolean` - Whether Excel/CSV reports are available
- `fileCount: number` - Number of files processed in this session
- `matchCount: number` - Number of successful expense matches
- `errorMessage?: string` - Error details if status is 'Error'

**Validation Rules**:
- `name` must be 1-100 characters, non-empty after trim
- `createdAt` must be valid Unix timestamp
- `expiresAt` must be createdAt + 1 year (31,536,000,000 ms)
- `backendSessionId` must be valid UUID format
- `lastUpdated` >= `createdAt`

**State Transitions**:
```
[Initial] → Processing → Complete
                    ↓ (on receipt update)
                   Updated
                    ↓ (on error)
                   Error
```

### SessionStorage
Container for all session data with automatic cleanup and limits.

**Attributes**:
- `sessions: Record<string, MonthSession>` - All sessions keyed by ID
- `activeSessionId: string | null` - Currently selected session
- `lastCleanup: number` - Unix timestamp of last expired session cleanup
- `version: number` - Schema version for migrations

**Validation Rules**:
- Maximum 24 sessions in `sessions` object
- `activeSessionId` must exist in `sessions` if not null
- `lastCleanup` updated on every access
- Expired sessions automatically removed on access

**Business Rules**:
- Sessions older than 1 year automatically purged
- Warning displayed when approaching 24 session limit
- Active session automatically cleared if referenced session expires

### ReceiptUpdate
Represents a receipt update operation with progress tracking.

**Attributes**:
- `sessionId: string` - Target session for update
- `file: File` - Expense report file for upload
- `progress: number` - Upload/processing progress (0-100)
- `status: 'uploading' | 'processing' | 'complete' | 'error'`
- `startedAt: number` - Unix timestamp when update began
- `completedAt?: number` - Unix timestamp when update finished
- `errorMessage?: string` - Error details if update failed

**Validation Rules**:
- `file` must be PDF format
- `file.size` must be < 50MB
- `sessionId` must reference existing session
- `progress` must be 0-100

### SessionFilter
Search and filter criteria for session browser.

**Attributes**:
- `searchTerm: string` - Text search across session names
- `statusFilter: SessionStatus[] | 'all'` - Filter by session status
- `dateRange: { start?: Date; end?: Date }` - Filter by creation date
- `sortBy: 'name' | 'createdAt' | 'lastUpdated'` - Sort criteria
- `sortOrder: 'asc' | 'desc'` - Sort direction

## Type Definitions

### SessionStatus
```typescript
type SessionStatus = 'Processing' | 'Complete' | 'Updated' | 'Error';
```

### SessionAction
```typescript
type SessionAction =
  | { type: 'CREATE_SESSION'; payload: { name: string; backendSessionId: string } }
  | { type: 'RENAME_SESSION'; payload: { id: string; name: string } }
  | { type: 'DELETE_SESSION'; payload: { id: string } }
  | { type: 'SET_ACTIVE_SESSION'; payload: { id: string | null } }
  | { type: 'UPDATE_SESSION_STATUS'; payload: { id: string; status: SessionStatus; errorMessage?: string } }
  | { type: 'UPDATE_SESSION_REPORTS'; payload: { id: string; hasReports: boolean; matchCount: number } }
  | { type: 'CLEANUP_EXPIRED_SESSIONS' };
```

### SessionContextType
```typescript
interface SessionContextType {
  storage: SessionStorage;
  activeSession: MonthSession | null;
  filteredSessions: MonthSession[];
  isLoading: boolean;
  error: string | null;

  // Actions
  createSession: (name: string, backendSessionId: string) => Promise<string>;
  renameSession: (id: string, name: string) => Promise<void>;
  deleteSession: (id: string) => Promise<void>;
  setActiveSession: (id: string | null) => void;
  updateReceipts: (sessionId: string, file: File) => Promise<void>;
  downloadReports: (sessionId: string, format: 'excel' | 'csv') => Promise<void>;

  // Filters
  setFilter: (filter: Partial<SessionFilter>) => void;
  clearFilter: () => void;
}
```

## Relationships

### Session ↔ Backend
- Each `MonthSession.backendSessionId` maps to backend session UUID
- Backend session lifecycle independent of frontend session management
- Reports generated by backend are linked through session ID

### Session ↔ LocalStorage
- All sessions stored in single localStorage key: `expense_sessions`
- Atomic read/write operations for data consistency
- Automatic cleanup on access to maintain storage limits

### Session ↔ User Interface
- Active session determines current view context
- Session list filtering operates on in-memory session array
- UI optimistically updates session state before backend confirmation

## Data Flow

### Session Creation
1. User inputs session name in SessionCreator
2. Frontend validates name (length, uniqueness)
3. Backend session created via existing API
4. Frontend session created with backend session ID
5. New session becomes active session
6. SessionStorage updated in localStorage

### Receipt Update
1. User selects file in ReceiptUpdater
2. File validation (type, size) performed
3. Upload progress tracked with optimistic UI
4. Backend processing via existing updateReceipts API
5. Session status updated based on backend response
6. Reports availability updated if successful
7. Error handling preserves original session state

### Session Expiration
1. Automatic cleanup on SessionStorage access
2. Expired sessions removed from storage
3. Active session cleared if expired
4. User notification if active session expired
5. Session list updated to reflect changes

## Storage Schema

### localStorage Key: `expense_sessions`
```json
{
  "sessions": {
    "uuid-1": {
      "id": "uuid-1",
      "name": "January 2024",
      "createdAt": 1704067200000,
      "expiresAt": 1735689600000,
      "status": "Complete",
      "backendSessionId": "backend-uuid-1",
      "lastUpdated": 1704067200000,
      "hasReports": true,
      "fileCount": 2,
      "matchCount": 15
    }
  },
  "activeSessionId": "uuid-1",
  "lastCleanup": 1704067200000,
  "version": 1
}
```

## Migration Strategy

### Version 1 → 2 (Future)
- Add new fields with default values
- Preserve existing session data
- Graceful fallback for missing fields
- Automatic migration on first access